async function handler({
  action,
  recordId,
  domainName,
  recordType,
  recordName,
  recordValue,
  ttl,
  priority,
}) {
  const session = getSession();
  if (!session || !session.user) {
    return { error: "Authentication required" };
  }

  const userId = session.user.id;
  const adminCheck =
    await sql`SELECT is_admin FROM auth_users WHERE id = ${userId}`;

  if (!adminCheck.length || !adminCheck[0].is_admin) {
    return { error: "Admin privileges required" };
  }

  const validRecordTypes = [
    "A",
    "AAAA",
    "CNAME",
    "MX",
    "TXT",
    "NS",
    "SRV",
    "CAA",
  ];
  if (
    action !== "list" &&
    action !== "get" &&
    !validRecordTypes.includes(recordType)
  ) {
    return { error: "Invalid record type" };
  }

  if ((action === "add" || action === "update") && !ttl) {
    ttl = 3600;
  }

  switch (action) {
    case "list":
      return await listDnsRecords(domainName);

    case "get":
      if (!recordId) {
        return { error: "Record ID is required" };
      }
      return await getDnsRecord(recordId);

    case "add":
      if (!domainName || !recordType || !recordName || !recordValue) {
        return {
          error:
            "Domain name, record type, record name, and record value are required",
        };
      }

      const validationError = validateRecordFormat(
        recordType,
        recordValue,
        priority
      );
      if (validationError) {
        return { error: validationError };
      }

      return await addDnsRecord(
        domainName,
        recordType,
        recordName,
        recordValue,
        ttl,
        priority
      );

    case "update":
      if (
        !recordId ||
        !domainName ||
        !recordType ||
        !recordName ||
        !recordValue
      ) {
        return {
          error:
            "Record ID, domain name, record type, record name, and record value are required",
        };
      }

      const updateValidationError = validateRecordFormat(
        recordType,
        recordValue,
        priority
      );
      if (updateValidationError) {
        return { error: updateValidationError };
      }

      return await updateDnsRecord(
        recordId,
        domainName,
        recordType,
        recordName,
        recordValue,
        ttl,
        priority
      );

    case "delete":
      if (!recordId) {
        return { error: "Record ID is required" };
      }
      return await deleteDnsRecord(recordId);

    default:
      return {
        error:
          "Invalid action. Use 'list', 'get', 'add', 'update', or 'delete'",
      };
  }
}

function validateRecordFormat(recordType, recordValue, priority) {
  switch (recordType) {
    case "A":
      const ipv4Regex = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;
      if (!ipv4Regex.test(recordValue)) {
        return "A record must contain a valid IPv4 address";
      }
      const ipv4Parts = recordValue.split(".");
      for (const part of ipv4Parts) {
        if (parseInt(part) > 255) {
          return "A record must contain a valid IPv4 address";
        }
      }
      break;

    case "AAAA":
      const ipv6Regex =
        /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$|^([0-9a-fA-F]{1,4}:){1,7}:|^([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}$|^([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}$|^([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}$|^([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}$|^([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}$|^[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})$|^:((:[0-9a-fA-F]{1,4}){1,7}|:)$/;
      if (!ipv6Regex.test(recordValue)) {
        return "AAAA record must contain a valid IPv6 address";
      }
      break;

    case "MX":
      if (priority === undefined || priority === null) {
        return "MX record requires a priority value";
      }
      if (isNaN(priority) || priority < 0 || priority > 65535) {
        return "MX record priority must be a number between 0 and 65535";
      }
      break;

    case "SRV":
      if (priority === undefined || priority === null) {
        return "SRV record requires a priority value";
      }
      if (isNaN(priority) || priority < 0 || priority > 65535) {
        return "SRV record priority must be a number between 0 and 65535";
      }
      break;
  }

  return null;
}

async function listDnsRecords(domainName) {
  try {
    let query = "SELECT * FROM dns_settings WHERE is_active = true";
    const values = [];
    let paramCount = 1;

    if (domainName) {
      query += ` AND domain_name = $${paramCount}`;
      values.push(domainName);
      paramCount++;
    }

    query += " ORDER BY domain_name, record_type, record_name";

    const records = await sql(query, values);
    return { success: true, records };
  } catch (error) {
    return { error: "Failed to retrieve DNS records: " + error.message };
  }
}

async function getDnsRecord(recordId) {
  try {
    const record = await sql`
      SELECT * FROM dns_settings 
      WHERE id = ${recordId}
    `;

    if (record.length === 0) {
      return { error: "Record not found" };
    }

    return { success: true, record: record[0] };
  } catch (error) {
    return { error: "Failed to retrieve DNS record: " + error.message };
  }
}

async function addDnsRecord(
  domainName,
  recordType,
  recordName,
  recordValue,
  ttl,
  priority
) {
  try {
    const existingRecord = await sql`
      SELECT * FROM dns_settings 
      WHERE domain_name = ${domainName} 
      AND record_type = ${recordType} 
      AND record_name = ${recordName}
      AND is_active = true
    `;

    if (existingRecord.length > 0) {
      return { error: "A similar record already exists" };
    }

    const newRecord = await sql`
      INSERT INTO dns_settings 
      (domain_name, record_type, record_name, record_value, ttl, priority, is_active, created_at, updated_at)
      VALUES 
      (${domainName}, ${recordType}, ${recordName}, ${recordValue}, ${ttl}, ${priority}, true, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
      RETURNING *
    `;

    return { success: true, record: newRecord[0] };
  } catch (error) {
    return { error: "Failed to add DNS record: " + error.message };
  }
}

async function updateDnsRecord(
  recordId,
  domainName,
  recordType,
  recordName,
  recordValue,
  ttl,
  priority
) {
  try {
    const existingRecord = await sql`
      SELECT * FROM dns_settings 
      WHERE id = ${recordId}
    `;

    if (existingRecord.length === 0) {
      return { error: "Record not found" };
    }

    const updatedRecord = await sql`
      UPDATE dns_settings 
      SET 
        domain_name = ${domainName},
        record_type = ${recordType},
        record_name = ${recordName},
        record_value = ${recordValue},
        ttl = ${ttl},
        priority = ${priority},
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ${recordId}
      RETURNING *
    `;

    return { success: true, record: updatedRecord[0] };
  } catch (error) {
    return { error: "Failed to update DNS record: " + error.message };
  }
}

async function deleteDnsRecord(recordId) {
  try {
    const existingRecord = await sql`
      SELECT * FROM dns_settings 
      WHERE id = ${recordId}
    `;

    if (existingRecord.length === 0) {
      return { error: "Record not found" };
    }

    await sql`
      UPDATE dns_settings 
      SET is_active = false, updated_at = CURRENT_TIMESTAMP
      WHERE id = ${recordId}
    `;

    return { success: true, message: "DNS record deleted successfully" };
  } catch (error) {
    return { error: "Failed to delete DNS record: " + error.message };
  }
}
